<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M6 XML to Packliv XLSX</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000000;
            color: #00FF00;
            font-family: 'Orbitron', 'Courier New', monospace;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 25% 25%, #003300 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, #001100 0%, transparent 50%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            border: 2px solid #00FF00;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 900;
            animation: pulse 2s infinite;
            background: radial-gradient(circle, #001100, #000000);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 10px #00FF00; }
            50% { box-shadow: 0 0 30px #00FF00, 0 0 40px #00FFFF; }
            100% { box-shadow: 0 0 10px #00FF00; }
        }

        h1 {
            font-size: 2.5em;
            color: #FFFFFF;
            text-shadow: 0 0 10px #00FFFF;
            margin-bottom: 10px;
        }

        h4 {
            font-size: 1.2em;
            color: #00FFFF;
            text-shadow: 0 0 5px #00FFFF;
            font-weight: 700;
        }

        .subtitle {
            color: #00FF00;
            font-size: 1.2em;
            margin-bottom: 30px;
        }

        .settings-panel {
            background: linear-gradient(145deg, #111111, #000000);
            border: 1px solid #00FF00;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }

        .settings-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 150px;
        }

        label {
            color: #00FF00;
            margin-bottom: 5px;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        select, input[type="text"] {
            background: #000000;
            border: 1px solid #00FFFF;
            color: #FFFFFF;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Orbitron', monospace;
            font-size: 14px;
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #00FF00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }

        .drop-zone {
            border: 2px dashed #00FFFF;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(145deg, #001111, #000000);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .drop-zone.dragover {
            border-color: #00FF00;
            background: linear-gradient(145deg, #002200, #001100);
            transform: scale(1.02);
        }

        .drop-zone h3 {
            color: #00FFFF;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .drop-zone p {
            color: #888888;
            margin-bottom: 20px;
        }

        button {
            background: linear-gradient(145deg, #00FF00, #00CCCC);
            color: #000000;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        button:hover {
            background: linear-gradient(145deg, #00FFFF, #00FF00);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .file-list {
            background: #111111;
            border: 1px solid #00FFFF;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .file-item {
            padding: 10px;
            border-bottom: 1px solid #333333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-name {
            color: #FFFFFF;
            font-size: 14px;
        }

        .remove-file {
            background: linear-gradient(145deg, #FF0000, #CC0000);
            color: #FFFFFF;
            padding: 5px 10px;
            font-size: 12px;
        }

        .preview-section {
            background: linear-gradient(145deg, #111111, #000000);
            border: 1px solid #00FF00;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }

        .preview-section h3 {
            color: #00FFFF;
            margin-bottom: 15px;
            font-size: 1.3em;
            text-align: center;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
            table-layout: fixed;
        }

        .data-table th,
        .data-table td {
            border: 1px solid #333333;
            padding: 8px;
            text-align: left;
            word-wrap: break-word;
        }

        /* Column width specifications */
        .data-table th:nth-child(1), .data-table td:nth-child(1) { width: 200px; } /* PAD Path */
        .data-table th:nth-child(2), .data-table td:nth-child(2) { width: 180px; } /* Subtitle VM */
        .data-table th:nth-child(3), .data-table td:nth-child(3) { width: 180px; } /* Subtitle SME */
        .data-table th:nth-child(4), .data-table td:nth-child(4) { width: 250px; } /* Title PGM Local */
        .data-table th:nth-child(5), .data-table td:nth-child(5) { width: 150px; } /* M6 ID */
        .data-table th:nth-child(6), .data-table td:nth-child(6) { width: 100px; } /* XML Needed */
        .data-table th:nth-child(7), .data-table td:nth-child(7) { width: 100px; } /* Revision ID */
        .data-table th:nth-child(8), .data-table td:nth-child(8) { width: 250px; } /* Title EP Local */
        .data-table th:nth-child(9), .data-table td:nth-child(9) { width: 250px; } /* Title PGM VO */
        .data-table th:nth-child(10), .data-table td:nth-child(10) { width: 250px; } /* Title EP VO */
        .data-table th:nth-child(11), .data-table td:nth-child(11) { width: 120px; } /* Film Format */
        .data-table th:nth-child(12), .data-table td:nth-child(12) { width: 180px; } /* Audio Preset */
        .data-table th:nth-child(13), .data-table td:nth-child(13) { width: 120px; } /* Language VO */
        .data-table th:nth-child(14), .data-table td:nth-child(14) { width: 80px; } /* Actions */

        .data-table th {
            background: linear-gradient(145deg, #003300, #001100);
            color: #00FF00;
            font-weight: 700;
            text-transform: uppercase;
        }

        .data-table td {
            background: #111111;
            color: #FFFFFF;
        }

        .data-table input {
            width: 100%;
            background: transparent;
            border: none;
            color: #FFFFFF;
            font-family: 'Orbitron', monospace;
            font-size: 11px;
            min-height: 20px;
        }

        .data-table input:focus {
            outline: 1px solid #00FFFF;
            background: #222222;
        }

        .data-table select {
            width: 100%;
            background: transparent;
            border: none;
            color: #FFFFFF;
            font-family: 'Orbitron', monospace;
            font-size: 11px;
            min-height: 22px;
        }

        .data-table select:focus {
            outline: 1px solid #00FFFF;
            background: #222222;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333333;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00FF00, #00FFFF);
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .hidden {
            display: none;
        }

        .error-message {
            background: linear-gradient(145deg, #330000, #110000);
            border: 1px solid #FF0000;
            color: #FF6666;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .success-message {
            background: linear-gradient(145deg, #003300, #001100);
            border: 1px solid #00FF00;
            color: #66FF66;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .settings-row {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .data-table {
                font-size: 10px;
                min-width: 1800px; /* Ensure table doesn't shrink too much */
            }
            
            .data-table th,
            .data-table td {
                padding: 4px;
            }

            .data-table input,
            .data-table select {
                font-size: 10px;
            }

            /* Bulk paste section responsive */
            #bulkPasteSection div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .subtitle {
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExMnprMnQ1bmZzamZtaGExbXM1cjBiNjY5cm16bGJ0c2Mxcmo3eTUwMCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/CKMYsrq8zkDXLS7UeN/giphy.gif" alt="Convertooor3000" style="max-width: 150px; margin: 20px auto 20px; display: block; border-radius: 10px;">
            <div class="subtitle">M6 XML to Packliv XLSX</div>
        </div>

        <div class="settings-panel">
            <div class="settings-row">
                <div class="form-group">
                    <label for="filmFormat">Film Format</label>
                    <select id="filmFormat">
                        <option value="1,33">1,33</option>
                        <option value="1,55">1,55</option>
                        <option value="1,66">1,66</option>
                        <option value="1,77" selected>1,77</option>
                        <option value="1,85">1,85</option>
                        <option value="2,00">2,00</option>
                        <option value="2,35">2,35</option>
                        <option value="2,40">2,40</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="audioPreset">Audio Preset</label>
                    <select id="audioPreset">
                        <option value="VF FRA" selected>VF FRA</option>
                        <option value="VO FRA">VO FRA</option>
                        <option value="VF FRA + VO">VF FRA + VO</option>
                        <option value="VF FRA + ADE">VF FRA + ADE</option>
                        <option value="VO FRA + ADE">VO FRA + ADE</option>
                        <option value="VF FRA + VO + ADE">VF FRA + VO + ADE</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="languageVO">Language VO</label>
                    <input type="text" id="languageVO" placeholder="Enter language">
                </div>
            </div>
        </div>

        <div class="drop-zone" id="dropZone">
            <h3>📁 DROP XML FILES HERE</h3>
            <p>Drag and drop your XML files or click to browse</p>
            <button type="button" onclick="document.getElementById('fileInput').click()">Browse Files</button>
            <input type="file" id="fileInput" multiple accept=".xml" style="display: none;">
        </div>

        <div id="fileListContainer" class="hidden">
            <div class="file-list" id="fileList"></div>
            <button onclick="clearFiles()">Clear All Files</button>
        </div>

        <div id="previewSection" class="preview-section hidden">
            <h3>📋 DATA PREVIEW & EDITOR</h3>
            <div style="margin-bottom: 15px; text-align: center;">
                <button onclick="parseFiles()">🔄 Parse XML Files</button>
                <button onclick="addNewRow()">➕ Add Row</button>
                <button onclick="toggleBulkPaste()">📝 Bulk Paste Paths</button>
            </div>
            
            <!-- Bulk Paste Section -->
            <div id="bulkPasteSection" class="settings-panel hidden" style="margin-bottom: 20px;">
                <h4 style="color: #00FFFF; margin-bottom: 15px;">📝 BULK PASTE PATHS</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label for="bulkPadPaths">PAD Paths (one per line)</label>
                        <textarea id="bulkPadPaths" rows="8" style="width: 100%; background: #000000; border: 1px solid #00FFFF; color: #FFFFFF; padding: 10px; border-radius: 5px; font-family: 'Orbitron', monospace; font-size: 12px; resize: vertical;" placeholder='"\\server\path\file1.mov"
"\\server\path\file2.mov"
"\\server\path\file3.mov"'></textarea>
                    </div>
                    <div class="form-group">
                        <label for="bulkSubVmPaths">Subtitle VM Paths (one per line)</label>
                        <textarea id="bulkSubVmPaths" rows="8" style="width: 100%; background: #000000; border: 1px solid #00FFFF; color: #FFFFFF; padding: 10px; border-radius: 5px; font-family: 'Orbitron', monospace; font-size: 12px; resize: vertical;" placeholder='"\\server\path\sub1_vm.xml"
"\\server\path\sub2_vm.xml"
"\\server\path\sub3_vm.xml"'></textarea>
                    </div>
                    <div class="form-group">
                        <label for="bulkSubSmePaths">Subtitle SME Paths (one per line)</label>
                        <textarea id="bulkSubSmePaths" rows="8" style="width: 100%; background: #000000; border: 1px solid #00FFFF; color: #FFFFFF; padding: 10px; border-radius: 5px; font-family: 'Orbitron', monospace; font-size: 12px; resize: vertical;" placeholder='"\\server\path\sub1_sme.xml"
"\\server\path\sub2_sme.xml"
"\\server\path\sub3_sme.xml"'></textarea>
                    </div>
                </div>
                <div style="text-align: center;">
                    <button onclick="applyBulkPaths()">✅ Apply Paths to Rows</button>
                    <button onclick="clearBulkPaths()" style="background: linear-gradient(145deg, #FF6600, #CC4400);">🗑️ Clear All</button>
                    <button onclick="toggleBulkPaste()">❌ Close</button>
                </div>
                <div style="margin-top: 10px; padding: 10px; background: #001122; border-radius: 5px; font-size: 11px;">
                    <strong>💡 Instructions:</strong>
                    <ul style="margin-left: 20px; color: #AAAAAA;">
                        <li>Paste paths one per line in each field</li>
                        <li>Paths can be with or without quotes (quotes will be automatically removed)</li>
                        <li>Supports both single (') and double (") quotes</li>
                        <li>Paths will be applied to rows in order (1st path → 1st row, 2nd path → 2nd row, etc.)</li>
                        <li>If you have fewer paths than rows, remaining rows will keep their current values</li>
                        <li>If you have more paths than rows, extra paths will be ignored with a warning</li>
                        <li>Empty lines will be automatically skipped</li>
                    </ul>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="data-table" id="dataTable">
                    <thead>
                        <tr>
                            <th>PAD Path</th>
                            <th>Subtitle VM Path</th>
                            <th>Subtitle SME Path</th>
                            <th>Title PGM Local</th>
                            <th>M6 ID</th>
                            <th>XML Needed</th>
                            <th>Revision ID</th>
                            <th>Title EP Local</th>
                            <th>Title PGM VO</th>
                            <th>Title EP VO</th>
                            <th>Film Format</th>
                            <th>Audio Preset</th>
                            <th>Language VO</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="progressContainer" class="hidden">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="action-buttons">
            <button onclick="parseFiles()" id="parseBtn">🔍 Parse XML Files</button>
            <button onclick="convertToExcel()" id="convertBtn">📊 Convert to Excel</button>
        </div>

        <div id="messages"></div>
    </div>

    <script>
        let xmlFiles = [];
        let parsedData = [];

        // File handling
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        document.getElementById('dropZone').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFileSelect({ target: { files: e.dataTransfer.files } });
        });

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (file.name.toLowerCase().endsWith('.xml') && !xmlFiles.some(f => f.name === file.name)) {
                    xmlFiles.push(file);
                }
            });
            updateFileList();
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            const container = document.getElementById('fileListContainer');
            
            if (xmlFiles.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            fileList.innerHTML = '';

            xmlFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span class="file-name">📄 ${file.name}</span>
                    <button class="remove-file" onclick="removeFile(${index})">❌</button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            xmlFiles.splice(index, 1);
            updateFileList();
            if (xmlFiles.length === 0) {
                document.getElementById('previewSection').classList.add('hidden');
                parsedData = [];
            }
        }

        function clearFiles() {
            xmlFiles = [];
            parsedData = [];
            updateFileList();
            document.getElementById('previewSection').classList.add('hidden');
            clearMessages();
        }

        function cleanText(text) {
            if (!text) return '';
            
            let cleaned = text;
            
            // FIRST: Fix corrupted encoding issues - common patterns when ISO-8859-1 is read as UTF-8
            const encodingFixes = {
                'Ã©': 'é', 'Ã¨': 'è', 'Ãª': 'ê', 'Ã«': 'ë',
                'Ã¡': 'á', 'Ã ': 'à', 'Ã¢': 'â', 'Ã£': 'ã', 'Ã¤': 'ä',
                'Ã­': 'í', 'Ã¬': 'ì', 'Ã®': 'î', 'Ã¯': 'ï',
                'Ã³': 'ó', 'Ã²': 'ò', 'Ã´': 'ô', 'Ãµ': 'õ', 'Ã¶': 'ö',
                'Ãº': 'ú', 'Ã¹': 'ù', 'Ã»': 'û', 'Ã¼': 'ü',
                'Ã§': 'ç', 'Ã±': 'ñ', 'Ã¿': 'ÿ', 'Ã½': 'ý',
                'Ã‰': 'É', 'Ã‡': 'Ç'
            };
            
            for (let [corrupted, correct] of Object.entries(encodingFixes)) {
                cleaned = cleaned.split(corrupted).join(correct);
            }
            
            // SECOND: Handle replacement characters by trying to guess what they should be based on context
            // Look for patterns like "Pok�mon" and fix them
            const commonWords = {
                'Pok�mon': 'Pokemon',
                'caf�': 'cafe',
                'cr�': 'cre',
                'th��tre': 'theatre',
                'fran�ais': 'francais',
                'gar�on': 'garcon',
                'le�on': 'lecon'
            };
            
            for (let [corrupted, fixed] of Object.entries(commonWords)) {
                cleaned = cleaned.split(corrupted).join(fixed);
            }
            
            // THIRD: Replace any remaining � with reasonable guesses or remove them
            // Try to fix common patterns
            cleaned = cleaned.replace(/([a-zA-Z])�([a-zA-Z])/g, '$1e$2'); // middle � becomes 'e'
            cleaned = cleaned.replace(/^�([a-zA-Z])/g, 'E$1'); // starting � becomes 'E'
            cleaned = cleaned.replace(/([a-zA-Z])�$/g, '$1e'); // ending � becomes 'e'
            cleaned = cleaned.replace(/([a-zA-Z])�([^a-zA-Z])/g, '$1e$2'); // � before non-letter becomes 'e'
            cleaned = cleaned.replace(/([^a-zA-Z])�([a-zA-Z])/g, '$1E$2'); // � after non-letter becomes 'E'
            
            // Remove any remaining � characters
            cleaned = cleaned.replace(/�/g, '');
            
            // FOURTH: Now handle normal accented characters (if any survived)
            const replacements = {
                'à': 'a', 'á': 'a', 'â': 'a', 'ã': 'a', 'ä': 'a', 'å': 'a',
                'è': 'e', 'é': 'e', 'ê': 'e', 'ë': 'e',
                'ì': 'i', 'í': 'i', 'î': 'i', 'ï': 'i',
                'ò': 'o', 'ó': 'o', 'ô': 'o', 'õ': 'o', 'ö': 'o',
                'ù': 'u', 'ú': 'u', 'û': 'u', 'ü': 'u',
                'ý': 'y', 'ÿ': 'y',
                'ç': 'c', 'ñ': 'n',
                'À': 'A', 'Á': 'A', 'Â': 'A', 'Ã': 'A', 'Ä': 'A', 'Å': 'A',
                'È': 'E', 'É': 'E', 'Ê': 'E', 'Ë': 'E',
                'Ì': 'I', 'Í': 'I', 'Î': 'I', 'Ï': 'I',
                'Ò': 'O', 'Ó': 'O', 'Ô': 'O', 'Õ': 'O', 'Ö': 'O',
                'Ù': 'U', 'Ú': 'U', 'Û': 'U', 'Ü': 'U',
                'Ý': 'Y', 'Ÿ': 'Y',
                'Ç': 'C', 'Ñ': 'N',
                'æ': 'ae', 'œ': 'oe', 'Æ': 'AE', 'Œ': 'OE'
            };
            
            for (let [accented, replacement] of Object.entries(replacements)) {
                if (cleaned.includes(accented)) {
                    cleaned = cleaned.split(accented).join(replacement);
                }
            }
            
            // FIFTH: Clean punctuation
            const punctuationToRemove = /[.,;:!?(){}[\]"«»""'']/g;
            cleaned = cleaned.replace(punctuationToRemove, ' ');
            
            // Normalize whitespace
            cleaned = cleaned.replace(/\s+/g, ' ').trim();
            
            return cleaned;
        }

        async function parseFiles() {
            if (xmlFiles.length === 0) {
                showMessage('Please select XML files first.', 'error');
                return;
            }

            showProgress(true);
            parsedData = [];
            
            try {
                for (let i = 0; i < xmlFiles.length; i++) {
                    const file = xmlFiles[i];
                    
                    // Read file as ArrayBuffer first to handle encoding properly
                    const arrayBuffer = await file.arrayBuffer();
                    
                    // Convert to text with explicit UTF-8 encoding
                    const decoder = new TextDecoder('utf-8');
                    const text = decoder.decode(arrayBuffer);
                    
                    console.log("Raw XML text sample:", text.substring(0, 200));
                    
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(text, 'text/xml');
                    
                    // Check for XML parsing errors
                    const parseError = xmlDoc.querySelector('parsererror');
                    if (parseError) {
                        console.error('XML parsing error:', parseError.textContent);
                        showMessage(`XML parsing error in file ${file.name}: ${parseError.textContent}`, 'error');
                        continue;
                    }
                    
                    const mediaDeliveries = xmlDoc.querySelectorAll('MediaDelivery');
                    
                    mediaDeliveries.forEach(md => {
                        const broadcasterId = md.querySelector('BroadcasterPrivateID')?.textContent || '';
                        const programSerie = md.querySelector('ProgramSerie')?.textContent || '';
                        let programTitle = md.querySelector('ProgramTitle')?.textContent || '';
                        
                        console.log("Raw values from XML:");
                        console.log("- broadcasterId:", broadcasterId);
                        console.log("- programSerie:", programSerie);
                        console.log("- programTitle:", programTitle);
                        
                        // Handle duplicate titles
                        if (programTitle.includes(' - ')) {
                            const parts = programTitle.split(' - ');
                            if (parts.length === 2 && parts[0].trim() === parts[1].trim()) {
                                programTitle = parts[0].trim();
                            }
                        }

                        const programSerieClean = cleanText(programSerie);
                        const programTitleClean = cleanText(programTitle);
                        
                        let titleEpLocal = programTitle;
                        let titleEpVo = programTitle;
                        
                        if (programTitle.includes(' - ')) {
                            const parts = programTitle.split(' - ');
                            titleEpLocal = parts[0] || programTitle;
                            titleEpVo = parts[1] || parts[0] || programTitle;
                        }

                        parsedData.push({
                            padPath: '',
                            subtitleVmPath: '',
                            subtitleSmePath: '',
                            titlePgmLocal: programSerieClean,
                            m6Id: broadcasterId,
                            xmlNeeded: 'true',
                            revisionId: '1',
                            titleEpLocal: cleanText(titleEpLocal),
                            titlePgmVo: programSerieClean,
                            titleEpVo: cleanText(titleEpVo),
                            filmFormat: document.getElementById('filmFormat').value,
                            audioPreset: document.getElementById('audioPreset').value,
                            languageVo: document.getElementById('languageVO').value
                        });
                    });
                    
                    updateProgress((i + 1) / xmlFiles.length * 100);
                }
                
                showProgress(false);
                updateDataTable();
                document.getElementById('previewSection').classList.remove('hidden');
                showMessage(`Successfully parsed ${parsedData.length} entries from ${xmlFiles.length} files.`, 'success');
                
            } catch (error) {
                showProgress(false);
                showMessage(`Error parsing XML files: ${error.message}`, 'error');
            }
        }

        function updateDataTable() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';

            parsedData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="text" value="${row.padPath}" onchange="updateRowData(${index}, 'padPath', this.value)"></td>
                    <td><input type="text" value="${row.subtitleVmPath}" onchange="updateRowData(${index}, 'subtitleVmPath', this.value)"></td>
                    <td><input type="text" value="${row.subtitleSmePath}" onchange="updateRowData(${index}, 'subtitleSmePath', this.value)"></td>
                    <td><input type="text" value="${row.titlePgmLocal}" onchange="updateRowData(${index}, 'titlePgmLocal', this.value)"></td>
                    <td><input type="text" value="${row.m6Id}" onchange="updateRowData(${index}, 'm6Id', this.value)"></td>
                    <td>
                        <select onchange="updateRowData(${index}, 'xmlNeeded', this.value)">
                            <option value="true" ${row.xmlNeeded === 'true' ? 'selected' : ''}>true</option>
                            <option value="false" ${row.xmlNeeded === 'false' ? 'selected' : ''}>false</option>
                        </select>
                    </td>
                    <td><input type="text" value="${row.revisionId}" onchange="updateRowData(${index}, 'revisionId', this.value)"></td>
                    <td><input type="text" value="${row.titleEpLocal}" onchange="updateRowData(${index}, 'titleEpLocal', this.value)"></td>
                    <td><input type="text" value="${row.titlePgmVo}" onchange="updateRowData(${index}, 'titlePgmVo', this.value)"></td>
                    <td><input type="text" value="${row.titleEpVo}" onchange="updateRowData(${index}, 'titleEpVo', this.value)"></td>
                    <td>
                        <select onchange="updateRowData(${index}, 'filmFormat', this.value)">
                            <option value="1,33" ${row.filmFormat === '1,33' ? 'selected' : ''}>1,33</option>
                            <option value="1,55" ${row.filmFormat === '1,55' ? 'selected' : ''}>1,55</option>
                            <option value="1,66" ${row.filmFormat === '1,66' ? 'selected' : ''}>1,66</option>
                            <option value="1,77" ${row.filmFormat === '1,77' ? 'selected' : ''}>1,77</option>
                            <option value="1,85" ${row.filmFormat === '1,85' ? 'selected' : ''}>1,85</option>
                            <option value="2,00" ${row.filmFormat === '2,00' ? 'selected' : ''}>2,00</option>
                            <option value="2,35" ${row.filmFormat === '2,35' ? 'selected' : ''}>2,35</option>
                            <option value="2,40" ${row.filmFormat === '2,40' ? 'selected' : ''}>2,40</option>
                        </select>
                    </td>
                    <td>
                        <select onchange="updateRowData(${index}, 'audioPreset', this.value)">
                            <option value="VF FRA" ${row.audioPreset === 'VF FRA' ? 'selected' : ''}>VF FRA</option>
                            <option value="VO FRA" ${row.audioPreset === 'VO FRA' ? 'selected' : ''}>VO FRA</option>
                            <option value="VF FRA + VO" ${row.audioPreset === 'VF FRA + VO' ? 'selected' : ''}>VF FRA + VO</option>
                            <option value="VF FRA + ADE" ${row.audioPreset === 'VF FRA + ADE' ? 'selected' : ''}>VF FRA + ADE</option>
                            <option value="VO FRA + ADE" ${row.audioPreset === 'VO FRA + ADE' ? 'selected' : ''}>VO FRA + ADE</option>
                            <option value="VF FRA + VO + ADE" ${row.audioPreset === 'VF FRA + VO + ADE' ? 'selected' : ''}>VF FRA + VO + ADE</option>
                        </select>
                    </td>
                    <td><input type="text" value="${row.languageVo}" onchange="updateRowData(${index}, 'languageVo', this.value)"></td>
                    <td><button class="remove-file" onclick="removeRow(${index})">🗑️</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateRowData(index, field, value) {
            if (parsedData[index]) {
                parsedData[index][field] = value;
            }
        }

        function removeRow(index) {
            parsedData.splice(index, 1);
            updateDataTable();
        }

        function addNewRow() {
            const newRow = {
                padPath: '',
                subtitleVmPath: '',
                subtitleSmePath: '',
                titlePgmLocal: '',
                m6Id: '',
                xmlNeeded: 'true',
                revisionId: '1',
                titleEpLocal: '',
                titlePgmVo: '',
                titleEpVo: '',
                filmFormat: document.getElementById('filmFormat').value,
                audioPreset: document.getElementById('audioPreset').value,
                languageVo: document.getElementById('languageVO').value
            };
            parsedData.push(newRow);
            updateDataTable();
        }

        function convertToExcel() {
            if (parsedData.length === 0) {
                showMessage('No data to convert. Please parse XML files first.', 'error');
                return;
            }

            try {
                showProgress(true);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // BATCH sheet
                const batchData = parsedData.map(row => ({
                    'pad_path': row.padPath,
                    'subtitle_vm_path': row.subtitleVmPath,
                    'subtitle_sme_path': row.subtitleSmePath,
                    'title_pgm_local': row.titlePgmLocal,
                    'm6_id': row.m6Id,
                    'xml_needed': row.xmlNeeded,
                    'revision_id': row.revisionId,
                    'title_ep_local': row.titleEpLocal,
                    'title_pgm_vo': row.titlePgmVo,
                    'title_ep_vo': row.titleEpVo,
                    'film_format': row.filmFormat,
                    'preset_audio_map': row.audioPreset,
                    'language_vo': row.languageVo
                }));
                
                const batchWs = XLSX.utils.json_to_sheet(batchData);
                XLSX.utils.book_append_sheet(wb, batchWs, 'BATCH');
                
                // HELP sheet
                const helpData = createHelpData();
                const helpWs = XLSX.utils.json_to_sheet(helpData);
                XLSX.utils.book_append_sheet(wb, helpWs, 'HELP');
                
                // JOB_DESCRIPTOR sheet
                const jobData = [{
                    'LABEL': 'PackLiv M6',
                    'ID': 218,
                    'VERSION': 21,
                    'VERSION_ID': 5034,
                    'DESCRIPTOR': 'JSON Descriptor Content'
                }];
                const jobWs = XLSX.utils.json_to_sheet(jobData);
                XLSX.utils.book_append_sheet(wb, jobWs, 'JOB_DESCRIPTOR');
                
                // Generate filename
                const currentDate = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const filename = `batch_PackLivM6_ID-218_V-21_LAST_${currentDate}.xlsx`;
                
                // Save file
                XLSX.writeFile(wb, filename);
                
                showProgress(false);
                showMessage(`Successfully converted to Excel! File: ${filename}`, 'success');
                
            } catch (error) {
                showProgress(false);
                showMessage(`Error converting to Excel: ${error.message}`, 'error');
            }
        }

        function createHelpData() {
            const parameters = [
                "pad_path", "subtitle_vm_path", "subtitle_sme_path", "title_pgm_local",
                "m6_id", "xml_needed", "revision_id", "title_ep_local", "title_pgm_vo",
                "title_ep_vo", "film_format", "preset_audio_map", "language_vo"
            ];

            const aide = [""] ;
            const requis = Array(13).fill("NON");
            const types = ["file", "file", "file", "char", "char", "boolean", "char", 
                          "char", "char", "char", "select", "select", "char"];
            const choix = [
                ...Array(10).fill("NA"),
                "1,33, 1,55, 1,66, 1,77, 1,85, 2,00, 2,35, 2,40",
                "VF FRA, VO FRA, VF FRA + VO, VF FRA + ADE, VO FRA + ADE, VF FRA + VO + ADE",
                "NA"
            ];
            const defaut = [...Array(5).fill("NC"), "true", ...Array(7).fill("NC")];

            return parameters.map((param, i) => ({
                'Parameter': `[Paramètre] : ${param}`,
                'Aide': `[Aide] : ${aide[i] || ''}`,
                'Requis': `[Requis] : ${requis[i]}`,
                'Type': `[Type] : ${types[i]}`,
                'Choix': `[Choix] : ${choix[i]}`,
                'Defaut': `[Défaut] : ${defaut[i]}`
            }));
        }

        function showProgress(show) {
            const container = document.getElementById('progressContainer');
            if (show) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
                document.getElementById('progressFill').style.width = '0%';
            }
        }

        function updateProgress(percentage) {
            document.getElementById('progressFill').style.width = percentage + '%';
        }

        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            
            messagesDiv.innerHTML = '';
            messagesDiv.appendChild(messageDiv);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        // Bulk paste functionality
        function toggleBulkPaste() {
            const bulkSection = document.getElementById('bulkPasteSection');
            bulkSection.classList.toggle('hidden');
        }

        function processPathList(pathText) {
            if (!pathText) return [];
            
            return pathText
                .split('\n')                          // Split by lines
                .map(line => line.trim())             // Trim whitespace
                .filter(line => line.length > 0)      // Remove empty lines
                .map(line => {
                    // Remove surrounding quotes (single or double)
                    if ((line.startsWith('"') && line.endsWith('"')) || 
                        (line.startsWith("'") && line.endsWith("'"))) {
                        line = line.slice(1, -1);
                    }
                    return line.trim();
                })
                .filter(path => path.length > 0);     // Remove empty paths after quote removal
        }

        function applyBulkPaths() {
            const padPaths = processPathList(document.getElementById('bulkPadPaths').value);
            const subVmPaths = processPathList(document.getElementById('bulkSubVmPaths').value);
            const subSmePaths = processPathList(document.getElementById('bulkSubSmePaths').value);

            if (padPaths.length === 0 && subVmPaths.length === 0 && subSmePaths.length === 0) {
                showMessage('Please enter at least one path to apply.', 'error');
                return;
            }

            if (parsedData.length === 0) {
                showMessage('No data rows available. Please parse XML files first.', 'error');
                return;
            }

            let appliedCount = 0;
            let appliedDetails = [];

            // Apply PAD paths
            if (padPaths.length > 0) {
                let padApplied = 0;
                padPaths.forEach((path, index) => {
                    if (index < parsedData.length) {
                        parsedData[index].padPath = path;
                        padApplied++;
                        appliedCount++;
                    }
                });
                appliedDetails.push(`${padApplied} PAD paths`);
            }

            // Apply Subtitle VM paths
            if (subVmPaths.length > 0) {
                let vmApplied = 0;
                subVmPaths.forEach((path, index) => {
                    if (index < parsedData.length) {
                        parsedData[index].subtitleVmPath = path;
                        vmApplied++;
                        appliedCount++;
                    }
                });
                appliedDetails.push(`${vmApplied} Subtitle VM paths`);
            }

            // Apply Subtitle SME paths
            if (subSmePaths.length > 0) {
                let smeApplied = 0;
                subSmePaths.forEach((path, index) => {
                    if (index < parsedData.length) {
                        parsedData[index].subtitleSmePath = path;
                        smeApplied++;
                        appliedCount++;
                    }
                });
                appliedDetails.push(`${smeApplied} Subtitle SME paths`);
            }

            updateDataTable();
            
            const detailsMsg = appliedDetails.length > 0 ? ` (${appliedDetails.join(', ')})` : '';
            showMessage(`Successfully applied ${appliedCount} total paths${detailsMsg} to the data rows.`, 'success');
            
            // Show warning if some paths couldn't be applied
            const totalPathsProvided = padPaths.length + subVmPaths.length + subSmePaths.length;
            if (totalPathsProvided > parsedData.length) {
                const excess = totalPathsProvided - appliedCount;
                showMessage(`Note: ${excess} paths were not applied because there are only ${parsedData.length} data rows available.`, 'error');
            }
            
            // Close the bulk paste section
            document.getElementById('bulkPasteSection').classList.add('hidden');
        }

        function clearBulkPaths() {
            document.getElementById('bulkPadPaths').value = '';
            document.getElementById('bulkSubVmPaths').value = '';
            document.getElementById('bulkSubSmePaths').value = '';
        }
    </script>
</body>
</html>